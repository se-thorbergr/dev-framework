# Scaffold MDK2 Project Specification

_Last updated: 2025-09-19 - Owner: geho_

## 1. Scope

- Provide a unified CLI (PowerShell/Bash) to create new Programmable Block scripts or mixins using MDK2 templates.
- Extend vanilla `dotnet new mdk2pbscript|mdk2mixin` behaviour with repo-specific conventions (config seeding, `.editorconfig` propagation, solution integration, initial build).
- Excludes submodule management (delegated to Scaffold Project Submodule spec).

## 2. Shared Responsibilities

- `ProjectName` refers to the `--name` value used for namespaces, csproj files, and MDK configuration (`ProjectName.mdk.ini`). `ProjectFolder` refers to the target directory where files are generated.
- Scripts: `tools/ScaffoldMdk2Project.ps1` and `tools/scaffold-mdk2-project.sh` must remain behaviourally identical and honor the shared CLI contract defined in `ToolingGeneral.md`.
- Requires dotnet SDK 9.0.\* with MDK2 template package 2.2.31 installed.
- Uses configuration keys from `se-config.ini` / `se-config.local.ini` to evaluate defaults for `ProjectName.mdk.ini` and the corresponding `ProjectName.mdk.local.ini` override file when scaffolding PB scripts (`--type pbscript`).
- Assumes execution within the repo root or accepts explicit output directory.

## 3. CLI Contract

See `ToolingGeneral.md` for mandatory shared options. This tool documents only its additional flags below.

All other shared switches (dry-run, verbosity, help, summary, CI) are inherited without change.

| Purpose              | PowerShell               | Bash                       | Notes                                                   |
| -------------------- | ------------------------ | -------------------------- | ------------------------------------------------------- |
| Project type         | `-Type <pbscript/mixin>` | `--type <pbscript\|mixin>` | Choose MDK template (default `pbscript`).               |
| Project name         | `-Name <string>`         | `--name <string>`          | Required; used for folder, namespace, config prefix.    |
| Output directory     | `-Output <path>`         | `--output <path>`          | Defaults to `./source/<type>/<ProjectName>`.            |
| Additional classes   | `-ClassName <name>`      | `--class-name <name>`      | Repeatable; generate stubs for partial classes.         |
| Solution integration | `-AddSln <path>`         | `--add-sln <path>`         | When provided, add project to solution (pbscript only). |

## 4. Workflow

1. Parse CLI, resolve defaults (type, ProjectName, ProjectFolder, solution path) and honour dry-run/logging flags. Default ProjectFolder is `./source/<type>/ProjectName` unless `--output` is supplied.
2. Validate prerequisites:
   - Confirm target directory absence (unless empty and allowed).
   - Ensure dotnet template availability (`dotnet new --list mdk2*`).
3. Invoke `dotnet new` with appropriate template (`mdk2pbscript` or `mdk2mixin`) into a temporary or final location depending on dry-run.
4. Apply repo conventions:
   - Copy `.editorconfig` (and future shared files) from repo root.
   - For PB scripts, seed missing `ProjectName.mdk.ini` / `ProjectName.mdk.local.ini` from `se-config.ini` / `se-config.local.ini`, then compute effective values and persist only differing keys into the `.local` file (with a generated header noting safe-to-edit overrides). Mixins do not create `.mdk` files.
   - Generate class stubs for each `ClassName` entry (C# file with namespace/project name, partial class?).
5. Integrate with solution (pbscript only): add generated `.csproj` using `dotnet sln <sln> add <project>` when requested/auto-detected.
6. Trigger initial build via `dotnet build` (pbscript) or template-specific command; capture output.
7. Summarize operations, point to next steps, and exit with corresponding code.

## 5. Configuration Handling

- Consume values from the `[mdk]` section (type, trace, minify, ignores, donotclean) plus dev-framework extensions under `[Paths]` and `[Build]`, using precedence `se-config.local.ini` → `se-config.ini` → template defaults. Persist only the keys that diverge into `ProjectName.mdk.local.ini`.
  - The `[mdk]` keys follow the MDK² Project Configuration Guide: <https://github.com/malforge/mdk2/wiki/MDK%C2%B2-Project-Configuration-Guide>.
- Honour `output` and `binarypath` `auto` semantics by leaving `auto` in project config and reporting resolved paths separately.
- Append comment banner noting file generated by scaffolder and safe-to-edit instructions.

## 6. Outputs

- Creates project directory containing MDK2 template output, class stubs, `.editorconfig`, and, for PB scripts, `ProjectName.mdk.ini` plus (when overrides exist) `ProjectName.mdk.local.ini`.
- Optionally updates solution file and any aggregated documentation index (future enhancement).
- Logs actions according to verbosity (debug includes dotnet command invocations, info summarises steps, quiet minimal).

## 7. Error Handling & Recovery

- Existing directory: abort with exit 1 unless `--force` (potential future option) is implemented.
- dotnet template failure: show command output, remove partially created directories when not dry-run.
- Solution modification failure: warn, continue with project creation, exit 1 to signal incomplete action.
- Build failure: surface diagnostics, exit 1 but leave project so developer can fix and re-run build.

## 8. Validation & Testing

- Unit tests for argument parsing, path resolution, class stub generation.
- Integration tests running dry-run and real scaffold on temp directories.
- Manual checks: pbscript creation with `--add-sln`, mixin creation without solution, repeated `--class-name` usage.
- Verification criteria: expected files present, `.sln` updated, build success (unless purposely invalid).

## 9. Open Questions / Future Enhancements

- Should scaffolder support additional template parameters (e.g., `--project`, `--language`)?
- Decide on namespace naming conventions for generated class stubs.
- Determine whether to auto-commit changes or leave for developer.

## 10. Change Log

| Date       | Change                                                                                       | Approved By |
| ---------- | -------------------------------------------------------------------------------------------- | ----------- |
| 2025-09-19 | Initial draft specification                                                                  | geho        |
| 2025-09-19 | Documented ProjectName/ProjectFolder terminology and PB-script-only `.mdk` config generation | geho        |
| 2025-09-20 | Clarified PB-script seeding from se-config templates and mixin exclusions                    | geho        |
| 2025-09-20 | Referenced ToolingGeneral shared CLI contract                                                | geho        |
